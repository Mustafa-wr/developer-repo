name: Deploy Sample Flask App

on:
  push:
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/**'
    branches: [main]

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout developer repo
        uses: actions/checkout@v4
      
      - name: Login to Docker Hub
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
      
      - name: Build and push image
        run: |
          docker build -t mostafawr/sample-flask-app:${{ github.sha }} .
          docker push mostafawr/sample-flask-app:${{ github.sha }}
      
      - name: Update platform repo GitOps manifest
        env:
          PLATFORM_REPO_TOKEN: ${{ secrets.PLATFORM_REPO_TOKEN }}
        run: |
          # Clone platform repo
          git clone https://oauth2:${PLATFORM_REPO_TOKEN}@github.com/Mustafa-wr/Kubernetes-Platform-Engineering.git platform
          
          cd platform
          
          # Update ONLY the image.tag value using awk for precision
          awk -v sha="${{ github.sha }}" '
            /name: image.tag/ { found=1; print; next }
            found && /value:/ { print "          value: " sha; found=0; next }
            { print }
          ' Falcon-Platform/gitops/apps/sample-flask.yaml > temp.yaml && \
          mv temp.yaml Falcon-Platform/gitops/apps/sample-flask.yaml
          
          # Commit and push
          git config user.name "GitHub Actions Bot"
          git config user.email "bot@github.com"
          git add Falcon-Platform/gitops/apps/sample-flask.yaml
          git commit -m "chore: update sample-flask to ${{ github.sha }}"
          git push